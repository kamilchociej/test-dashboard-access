default:
  service:
    repository: ghcr.io/streamx-dev/streamx
    tag: latest-jvm
  environment:
    GLOBAL_MESH_VARIABLE: "globalValue"
  environmentFrom:
    secrets:
      - secret.properties
descriptors:
  relay:
    type: "processing"
    containers:
      service:
        incoming:
          events: {}
        outgoing:
          relayed-events: {}

  sitemap-generator:
    type: "processing"
    containers:
      processor:
        image: "ghcr.io/streamx-com/streamx-blueprints/sitemap-generator:3.0.7-jvm"
        incoming:
          incoming-pages: {}
        outgoing:
          outgoing-sitemaps: {}

  indexable-resources-producer:
    type: "processing"
    containers:
      processor:
        image: "ghcr.io/streamx-com/streamx-blueprints/indexable-resources-producer:3.0.7-jvm"
        incoming:
          pages: {}
          fragments: {}
        outgoing:
          indexable-resources: {}
          indexable-resource-fragments: {}

  web-server-sink:
    type: "edge"
    containers:
      sink:
        image: "ghcr.io/streamx-com/streamx-blueprints/web-server-sink:3.0.7-jvm"
        incoming:
          resources: {}
        environment:
          STREAMX_BLUEPRINTS_WEB_SERVER_SINK_STORAGE_ROOT_DIRECTORY: "/srv/www"
        volumes:
          - "repository-volume:/srv/www"
      webserver:
        image: "docker.io/library/nginx:1.26.0"
        servicePorts:
          - "80:80"
        volumes:
          - "repository-volume:/usr/share/nginx/html"
        healthCheck: null
    volumes:
      repository-volume: {}

  opensearch-sink:
    type: "edge"
    containers:
      sink:
        image: "ghcr.io/streamx-com/streamx-blueprints/opensearch-sink:3.0.7-jvm"
        incoming:
          indexable-resources: {}
          indexable-resource-fragments: {}
        servicePorts:
          - "8089:8080"
        volumes:
          - "repository-volume:/usr/share/opensearch/data"
      opensearch:
        image: "docker.io/opensearchproject/opensearch:2.16.0"
        servicePorts:
          - "9200:9200"
          - "9300:9300"
        volumes:
          - "repository-volume:/usr/share/opensearch/data"
        healthCheck: "/_cluster/health"

sources:
  resources-source:
    outgoing:
      - ref: "inbox.pages"
        produces:
          - "com.streamx.blueprints.page.published.v1"
          - "com.streamx.blueprints.page.unpublished.v1"
      - ref: "inbox.assets"
        produces:
          - "com.streamx.blueprints.asset.published.v1"
          - "com.streamx.blueprints.asset.unpublished.v1"
      - ref: "inbox.web-resources"
        produces:
          - "com.streamx.blueprints.web-resource.published.v1"
          - "com.streamx.blueprints.web-resource.unpublished.v1"

ingestion:
  rest-ingestion:
    containers:
      proxy:
        environment:
          QUARKUS_HTTP_AUTH_PERMISSION_BEARER_POLICY: permit

processing:
  pages-relay:
    descriptor: relay
    containers:
      service:
        incoming:
          events:
            ref: inbox.pages
        outgoing:
          relayed-events:
            ref: outbox.pages

  assets-relay:
    descriptor: relay
    containers:
      service:
        incoming:
          events:
            ref: inbox.assets
        outgoing:
          relayed-events:
            ref: outbox.assets

  web-resources-relay:
    descriptor: relay
    containers:
      service:
        incoming:
          events:
            ref: inbox.web-resources
        outgoing:
          relayed-events:
            ref: outbox.web-resources

  sitemap-generator-service:
    descriptor: sitemap-generator
    containers:
      processor:
        incoming:
          incoming-pages:
            ref: inbox.pages
        outgoing:
          outgoing-sitemaps:
            ref: outbox.web-resources
        environment:
          STREAMX_BLUEPRINTS_SITEMAP_GENERATOR_BASE_URL: "http://streamx.127.0.0.1.nip.io"
          STREAMX_BLUEPRINTS_SITEMAP_GENERATOR_OUTPUT_KEY: "sitemap.xml"

  indexable-resources-producer-service:
    descriptor: indexable-resources-producer
    containers:
      processor:
        incoming:
          pages:
            ref: inbox.pages
          fragments: # unused
            ref: inbox.fragments
        outgoing:
          indexable-resources:
            ref: outbox.indexable-resources
          indexable-resource-fragments: # unused
            ref: outbox.indexable-resource-fragments

edge:
  web-server-sink-service:
    descriptor: web-server-sink
    containers:
      sink:
        incoming:
          resources:
            ref: outbox.pages,outbox.assets,outbox.web-resources
        environment:
          STREAMX_BLUEPRINTS_WEB_SERVER_SINK_PROCESS_NAMESPACE_IN_INGESTION_KEYS: "false"
      webserver:
        volumesFrom:
          configs:
            - "nginx.conf:/etc/nginx/conf.d/default.conf"

  opensearch-sink-service:
    descriptor: opensearch-sink
    volumes:
      repository-volume: {}
    containers:
      sink:
        incoming:
          indexable-resources:
            ref: outbox.indexable-resources
          indexable-resource-fragments: # unused
            ref: outbox.indexable-resource-fragments
        volumesFrom:
          configs:
            - "opensearch/service-init:/deployments/opensearch/service-init/additional"
        environment:
          QUARKUS_ELASTICSEARCH_HOSTS: "opensearch-sink-service.opensearch:9200"
          STREAMX_BLUEPRINTS_OPENSEARCH_SINK_TYPE_REQUIRED: "false"
      opensearch:
        environment:
          DISABLE_SECURITY_PLUGIN: "true"
          OPENSEARCH_INITIAL_ADMIN_PASSWORD: "myStrongPassword123@456"
          discovery.type: "single-node"
